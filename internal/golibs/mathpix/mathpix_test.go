package mathpix

import (
	"context"
	"errors"
	"testing"
	"time"

	mock_curl "github.com/manabie-com/backend/mock/golibs/curl"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
)

func TestMathpixImpl_DetectLatexFromImage(t *testing.T) {
	t.Parallel()
	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()

	mockIHttp := &mock_curl.IHTTP{}
	m := &FactoryImpl{
		HTTP:   mockIHttp,
		AppID:  "app_id",
		AppKey: "app_key",
	}

	testCases := []struct {
		Name        string
		Ctx         context.Context
		Content     string
		Setup       func(ctx context.Context)
		ExpectedErr error
	}{
		{
			Name:    "err DetectTexFromImage",
			Ctx:     ctx,
			Content: "data:image/png;base64,...err content",
			Setup: func(ctx context.Context) {
				mockIHttp.On("Request", mock.Anything, mock.Anything, mock.Anything, mock.Anything, mock.Anything).Once().Return(errors.New("error Request"))
			},
			ExpectedErr: errors.New("error Request"),
		},
		{
			Name:    "happy case",
			Ctx:     ctx,
			Content: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAG0AAABXCAYAAAAOGcudAAAAAXNSR0IArs4c6QAAEh1JREFUeF7t3VWMLFUTB/BzcXd3dwvu7u4QPLiGwAsP8MQDIQGCk0Bwd3d3d3d3d4dLfuej9usdZnd7emR3YDqZ7MydPt2n61/yrzp15o4aPXr06NQ7ukoCo3qgdRVeebI90LoPsx5oXYhZD7QeaN0ogS6ccy+m9UDrQgl04ZR7ltYDrQsl0IVT7llaD7QulEAXTrlnaT3QulACXTjlnqX1QOtCCXThlHuWllKypDhq1Kg++Go/jzRce6D9Ddr333+fvvzyyzTppJOmSSaZJINYBHIkATfsoNUunHdSUHHv3377LT3++OPpvvvuS+utt16af/7509hjjz2ScOo3l2EDrRas+NwuDXf9X3/9NX311Vfpjz/+SBNPPHGaYIIJsmt866230pVXXpk+++yztNdee6U55pgjjTXWWD3QaiXw+++/Z3f0wQcfZGFOPfXUadppp82CbIe1AefFF19Md9xxR/r888/TkksumZZeeun07bffpquvvjo9+eSTabPNNksbbbRRGn/88dsyh1ZpQUctreiOaPc999yTQeOeppxyyrTCCiukRRZZpC1Cc++XXnop3/Oxxx5L00wzTVp77bWzlZ1yyilpxhlnTMcff3yaffbZWyXbtl2no6BxS7/88kvW+Ntuuy198sknae65585a/e6776ZZZpklrbrqqlmA44wzThp33HHTGGOM0ZKHD/f4ww8/ZOC8WPUXX3yRrr/++rTyyiunc889d0THshBER0ALCs0NPv/88+mKK65IhEfTl1lmmTyXO++8M4M522yzpVlnnTVNNdVUObYQbO1RlZKHpZvDaaedlt54442sIM8++2yaa6650vnnn98/4BfSgJZoTosu0hHQ/vzzz+T19ttvZ8EI+FtuuWUGLMgA9vbAAw8k1JuFESLt5zaLB8G7Fqsdc8wx61riYDGRK+YezQNDXHTRRdONN96YrR2QE000Ub6mz62y8hZh1XeZjoGGdGBoTz/9dNp8883T8ssv3y92ff311+nll19OjzzySAYVUeAqJ5tssr7JAgqoXCzXOt5442UW6ACkg1udcMIJ83e14Dnn448/TpdffnmOZRtuuGG25muuuSY9/PDDaYMNNsjkRLxz3WCy7WK0VcHsCGi0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",
			Setup: func(ctx context.Context) {
				mockIHttp.On("Request", mock.Anything, mock.Anything, mock.Anything, mock.Anything, mock.Anything).Once().Return(nil)
			},
		},
	}

	for _, testCase := range testCases {
		t.Run(testCase.Name, func(t *testing.T) {
			testCase.Setup(testCase.Ctx)
			_, err := m.DetectLatexFromImage(testCase.Ctx, testCase.Content)

			if testCase.ExpectedErr != nil {
				assert.Equal(t, testCase.ExpectedErr.Error(), err.Error())
			} else {
				assert.Equal(t, testCase.ExpectedErr, err)
			}
		})
	}
}
