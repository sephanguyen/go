SET 'auto.offset.reset' = 'earliest';

CREATE STREAM IF NOT EXISTS PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1  WITH (kafka_topic='{{ .Values.global.environment }}.kec.datalake.invoicemgmt.partner_convenience_store', value_format='AVRO');

CREATE STREAM IF NOT EXISTS PARTNER_CONVENIENCE_STORE_STREAM_FORMATTED_V1
    AS SELECT
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->PARTNER_CONVENIENCE_STORE_ID AS KEY,
        AS_VALUE(PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->PARTNER_CONVENIENCE_STORE_ID) AS PARTNER_CONVENIENCE_STORE_ID,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MANUFACTURER_CODE AS MANUFACTURER_CODE,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->COMPANY_CODE AS COMPANY_CODE,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->SHOP_CODE AS SHOP_CODE,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->COMPANY_NAME AS COMPANY_NAME,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->COMPANY_TEL_NUMBER AS COMPANY_TEL_NUMBER,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->POSTAL_CODE AS POSTAL_CODE,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->ADDRESS1 AS ADDRESS1,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->ADDRESS2 AS ADDRESS2,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE1 AS MESSAGE1,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE2 AS MESSAGE2,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE3 AS MESSAGE3,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE4 AS MESSAGE4,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE5 AS MESSAGE5,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE6 AS MESSAGE6,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE7 AS MESSAGE7,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE8 AS MESSAGE8,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE9 AS MESSAGE9,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE10 AS MESSAGE10,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE11 AS MESSAGE11,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE12 AS MESSAGE12,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE13 AS MESSAGE13,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE14 AS MESSAGE14,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE15 AS MESSAGE15,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE16 AS MESSAGE16,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE17 AS MESSAGE17,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE18 AS MESSAGE18,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE19 AS MESSAGE19,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE20 AS MESSAGE20,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE21 AS MESSAGE21,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE22 AS MESSAGE22,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE23 AS MESSAGE23,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->MESSAGE24 AS MESSAGE24,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->REMARKS AS REMARKS,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->IS_ARCHIVED AS IS_ARCHIVED,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->CREATED_AT AS CREATED_AT,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->UPDATED_AT AS UPDATED_AT,
        PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->DELETED_AT AS DELETED_AT
    FROM PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1
    WHERE PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->RESOURCE_PATH = '{{ .Values.kecResourcePath }}'
    PARTITION BY PARTNER_CONVENIENCE_STORE_STREAM_ORIGIN_V1.AFTER->PARTNER_CONVENIENCE_STORE_ID
    EMIT CHANGES;

CREATE TABLE IF NOT EXISTS PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1 (KEY VARCHAR PRIMARY KEY) with (kafka_topic='{{ .Values.topicPrefix }}PARTNER_CONVENIENCE_STORE_STREAM_FORMATTED_V1', value_format='AVRO');

CREATE TABLE IF NOT EXISTS PARTNER_CONVENIENCE_STORE_V1
AS SELECT
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.KEY as ID,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.PARTNER_CONVENIENCE_STORE_ID as PARTNER_CONVENIENCE_STORE_ID,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MANUFACTURER_CODE AS MANUFACTURER_CODE,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.COMPANY_CODE AS COMPANY_CODE,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.SHOP_CODE AS SHOP_CODE,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.COMPANY_NAME AS COMPANY_NAME,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.COMPANY_TEL_NUMBER AS COMPANY_TEL_NUMBER,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.POSTAL_CODE AS POSTAL_CODE,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.ADDRESS1 AS ADDRESS1,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.ADDRESS2 AS ADDRESS2,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE1 AS MESSAGE1,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE2 AS MESSAGE2,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE3 AS MESSAGE3,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE4 AS MESSAGE4,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE5 AS MESSAGE5,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE6 AS MESSAGE6,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE7 AS MESSAGE7,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE8 AS MESSAGE8,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE9 AS MESSAGE9,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE10 AS MESSAGE10,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE11 AS MESSAGE11,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE12 AS MESSAGE12,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE13 AS MESSAGE13,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE14 AS MESSAGE14,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE15 AS MESSAGE15,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE16 AS MESSAGE16,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE17 AS MESSAGE17,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE18 AS MESSAGE18,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE19 AS MESSAGE19,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE20 AS MESSAGE20,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE21 AS MESSAGE21,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE22 AS MESSAGE22,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE23 AS MESSAGE23,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.MESSAGE24 AS MESSAGE24,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.REMARKS AS REMARKS,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.IS_ARCHIVED AS IS_ARCHIVED,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.CREATED_AT AS CREATED_AT,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.UPDATED_AT AS UPDATED_AT,
    PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1.DELETED_AT AS DELETED_AT
FROM PARTNER_CONVENIENCE_STORE_TABLE_FORMATTED_V1;

CREATE SINK CONNECTOR IF NOT EXISTS SINK_PARTNER_CONVENIENCE_STORE_V1 WITH (
      'connector.class'='io.confluent.connect.jdbc.JdbcSinkConnector',
      'transforms.unwrap.delete.handling.mode'='drop',
      'tasks.max'='1',
      'topics'='{{ .Values.topicPrefix }}PARTNER_CONVENIENCE_STORE_V1',
      'fields.whitelist'='partner_convenience_store_key,partner_convenience_store_id,manufacturer_code,company_code,shop_code,company_name,company_tel_number,postal_code,address1,address2,message1,message2,message3,message4,message5,message6,message7,message8,message9,message10,message11,message12,message13,message14,message15,message16,message17,message18,message19,message20,message21,message22,message23,message24,remarks,is_archived,created_at,updated_at,deleted_at',
      'key.converter'='org.apache.kafka.connect.storage.StringConverter',
      'value.converter'='io.confluent.connect.avro.AvroConverter',
      'value.converter.schema.registry.url'='{{ .Values.cpRegistryHost }}',
      'delete.enabled'='false',
      'transforms.unwrap.drop.tombstones'='true',
      'auto.create'='true',
      'connection.url'='${file:/decrypted/kafka-connect.secrets.properties:kec_url}',
      'insert.mode'='upsert',
      'table.name.format'='public.partner_convenience_store',
      'pk.mode'='record_value',
      'transforms'='RenameField',
      'transforms.RenameField.type'= 'org.apache.kafka.connect.transforms.ReplaceField$Value',
      'transforms.RenameField.renames'='KEY:partner_convenience_store_key,PARTNER_CONVENIENCE_STORE_ID:partner_convenience_store_id,MANUFACTURER_CODE:manufacturer_code,COMPANY_CODE:company_code,SHOP_CODE:shop_code,COMPANY_NAME:company_name,COMPANY_TEL_NUMBER:company_tel_number,POSTAL_CODE:postal_code,ADDRESS1:address1,ADDRESS2:address2,MESSAGE1:message1,MESSAGE2:message2,MESSAGE3:message3,MESSAGE4:message4,MESSAGE5:message5,MESSAGE6:message6,MESSAGE7:message7,MESSAGE8:message8,MESSAGE9:message9,MESSAGE10:message10,MESSAGE11:message11,MESSAGE12:message12,MESSAGE13:message13,MESSAGE14:message14,MESSAGE15:message15,MESSAGE16:message16,MESSAGE17:message17,MESSAGE18:message18,MESSAGE19:message19,MESSAGE20:message20,MESSAGE21:message21,MESSAGE22:message22,MESSAGE23:message23,MESSAGE24:message24,REMARKS:remarks,IS_ARCHIVED:is_archived,CREATED_AT:created_at,UPDATED_AT:updated_at,DELETED_AT:deleted_at',
      'pk.fields'='partner_convenience_store_id'
);
